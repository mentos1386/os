---
name: Build Custom Image
on:
  pull_request:
    branches:
      - main
  schedule:
    - cron: '05 10 * * *'  # 10:05am UTC everyday
  push:
    branches:
      - main
    paths-ignore:
      - '**/README.md'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build_push:
    runs-on: ubuntu-latest
    name: Build and push image
    strategy:
      fail-fast: false
      matrix:
        flavor: [bazzite-deck-gnome, bazzite-gnome]
        version: [42, 43]

    env:
      IMAGE_NAME: "os-${{ matrix.flavor }}"
      IMAGE_REGISTRY: "code.tjo.space/mentos1386"

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4

      - name: Install devbox
        uses: jetify-com/devbox-install-action@961cad8246f221a1c5f0ecf481fbbf58ee9a1ceb # v0.14.0
        env:
          GITHUB_TOKEN: ${{ secrets.NIX_GITHUB_TOKEN }}
        with:
          enable-cache: false
          github-token: "${{ secrets.NIX_GITHUB_TOKEN }}"

      - name: Build Image
        run: |
          set -x
          sudo podman image trust set --type accept default
          devbox run -- buildah build \
            --file Containerfile \
            --build-arg FLAVOR=${{ matrix.flavor }} \
            --build-arg VERSION=${{ matrix.version }} \
            --tag ${{ env.IMAGE_NAME }} \
            --label "org.opencontainers.image.created=$(date -u +%Y\-%m\-%d\T%H\:%M\:%S\Z)" \
            --label "org.opencontainers.image.version=${{ github.ref_name }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.title=${{ env.IMAGE_NAME }}"

      - name: Push image
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: |
          echo "${{ secrets.PACKAGES_TOKEN }}" | devbox run -- buildah login -u ${{ github.actor }} --password-stdin
          echo "${{ secrets.PACKAGES_TOKEN }}" | devbox run -- skopeo login -u ${{ github.actor }} --password-stdin

          IMAGE="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}"

          echo "- Pushing image"
          devbox run -- buildah push raw-image-os docker://${IMAGE}:${{ github.sha }}

          for tag in latest latest.$(date -u +%Y\%m\%d) $(date -u +%Y\%m\%d) ${{ github.ref_name }}; do
            echo "- Copying to ${tag}"
            devbox run -- skopeo copy docker://${IMAGE}:${{ github.sha }} docker://${IMAGE}:${tag}
          done

      - name: Sign container image
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: |
          IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}"

          for tag in latest latest.$(date -u +%Y\%m\%d) $(date -u +%Y\%m\%d) ${{ github.ref_name }} ${{ github.sha }}; do
            devbox run -- cosign sign -y --key env://COSIGN_PRIVATE_KEY $IMAGE_FULL:$tag
          done
        env:
          COSIGN_EXPERIMENTAL: false
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
